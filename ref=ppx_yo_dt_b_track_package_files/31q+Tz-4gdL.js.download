(function(g){var h=window.AmazonUIPageJS||window.P,q=h._namespace||h.attributeErrors,c=q?q("RexMaptrackingJS",""):h;c.guardFatal?c.guardFatal(g)(c,window):c.execute(function(){g(c,window)})})(function(g,h,q){g.declare("rex-maptracker-constants",{classPrefix:"rex-maptracking",icons:{agent:"https://do6e2c3moa96p.cloudfront.net/StaticContent/pm_driver_pin.png",destination:"https://do6e2c3moa96p.cloudfront.net/StaticContent/pm_destination_pin.png",default:"https://do6e2c3moa96p.cloudfront.net/StaticContent/pm_destination_pin.png"},
maxZoom:17,platform:{here:{app_id:"FS1rcDYpsifo3E1tyXb6",app_code:"uMJ-il_IZ-9B_fkF-BpsUg",useHTTPS:!0}},styles:{deliveryAgentBubble:{style:{body:{backgroundColor:"#fff",color:"#000",fontSize:".8em",padding:".3em .1em",right:"-3.75em",bottom:"4em",borderRadius:"1em",textAlign:"center"},content:{minWidth:"8em"}},tail:{path:{fill:"#FFF"},viewBox:"0 0 20 20",shape:"M0 0 L6 8 L12 0 Z",style:{bottom:"2em"}}},destinationBubble:{style:{body:{backgroundColor:"#fff",color:"#000",fontSize:".8em",padding:".3em .1em",
right:"-3.75em",bottom:"2.5em",borderRadius:"1em",textAlign:"center"},content:{minWidth:"8em"}}}}});g.register("rex-maptracker-environments",function(){function c(){var a=h.location.hostname,b="";null!=a&&""!=a&&(b=a.split(".").pop());return b}function f(){var a=!1,b=h.location.hostname;e.forEach(function(k){b.includes(k)&&(a=!0)});return a}var e=["development","pre-prod"],a={com:{region:"na",domain:"com",imperial:!0},uk:{region:"eu",domain:"co.uk",imperial:!1},de:{region:"eu",domain:"de",imperial:!1},
fr:{region:"eu",domain:"fr",imperial:!1},es:{region:"eu",domain:"es",imperial:!1},it:{region:"eu",domain:"it",imperial:!1},"":{region:"na",domain:"com",imperial:!0}};return{getTopLevelDomain:c,getEnvConfig:function(){var d=f(),b;d?(b=h.location.hostname.split(".")[0],b=b.substring(0,b.indexOf("pre-prod")-1)):b=c();a[b]||(b="com");b=a[b]||{};b.isPreProd=d;return b}}});g.when("A","rex-maptracker-constants").register("rex-maptracker-item",function(c,f){function e(a,d,b,k){this.type=a;this.latitude=d;
this.longitude=b;this.bubbleContent=k||"";this.icon=f.icons[a]||f.icons.default;this.initialized=!1}e.itemType={DELIVERY_AGENT:"agent",DESTINATION:"destination"};e.prototype.init=function(a){this.initialized||(this.maptracker=a,this.marker=new H.map.Marker({lat:this.latitude,lng:this.longitude},{icon:new H.map.Icon(this.icon)}),this.bubble=this.type===e.itemType.DELIVERY_AGENT?f.styles.deliveryAgentBubble:f.styles.destinationBubble,this.updateBubble(this.bubbleContent),this.maptracker.map.addObject(this.marker),
this.initialized=!0)};e.prototype.updateBubble=function(a){this.bubble.instant||(this.type===e.itemType.DELIVERY_AGENT?this.instantiateAgent():this.instantiateDestination());this.bubbleContent=a;this.bubble.instant&&(this.bubble.instant.setContent(this.bubbleContent),this.bubbleContent?this.bubble.instant.open():this.bubble.instant.close(),this.marker&&this.bubble.instant.setPosition(this.marker.getPosition()))};e.prototype.updateLocation=function(a,d){this.latitude=a;this.longitude=d;this.marker&&
this.marker.setPosition({lat:a,lng:d})};e.prototype.remove=function(){this.maptracker.map.removeObject(this.marker);this.maptracker.ui.removeBubble(this.bubble)};e.prototype.instantiateAgent=function(){this.bubble.instant=new H.ui.InfoBubble(this.marker.getPosition(),{content:""});var a=this.maptracker.mapElement.id+"-da-bubble";this.bubble.instant.addClass(a);this.maptracker.ui.addBubble(this.bubble.instant);var a=c.$("."+a),d=a.children(".H_ib_body"),b=document.querySelector(".H_ib_body");b.classList.remove("H_ib_body");
b.classList.add("agent");d.children(".H_ib_close").hide();d.children(".H_ib_content").css(this.bubble.style.content);a=a.children(".H_ib_tail");d=c.$("\x3cg\x3e").append(c.$("\x3cpath\x3e").attr("d",this.bubble.tail.shape).css(this.bubble.tail.path));d=c.$("\x3csvg\x3e").attr("viewBox",this.bubble.tail.viewBox).append(d);a.html(d);d=document.querySelector(".H_ib_tail");d.classList.add("agent-tail");d.classList.remove("H_ib_tail");a.html(a.html())};e.prototype.instantiateDestination=function(){this.bubble.instant=
new H.ui.InfoBubble(this.marker.getPosition(),{content:""});var a=this.maptracker.mapElement.id+"-de-bubble";this.bubble.instant.addClass(a);this.maptracker.ui.addBubble(this.bubble.instant);a=c.$("."+a);a.css({height:"0"});var d=document.querySelector(".H_ib_body");d.classList.remove("H_ib_body");d.classList.add("destination");var b=document.querySelector(".H_ib_content");b.classList.remove("H_ib_content");b.classList.add("bubble-content");a.children(".destination").children(".H_ib_close").hide();
b=document.querySelector(".H_ib_tail");b.classList.remove("H_ib_tail");b.classList.add("destination-tail");a.children(".destination-tail").hide();d.classList.add("show-destination")};return e});g.when("rex-maptracker-constants","rex-maptracker-environments","pt2-page-utils").register("rex-maptracker",function(c,f,e){function a(k){this.options=k||{};this.mapItems={};this.env=f.getEnvConfig();this.state=a.states.STARTUP;this.initialZoomTriggered=this.interactedWith=this.destroyed=!1}function d(){h.ue&&
h.ue.count&&h.ue.count("persistent-map-interaction",(h.ue.count("persistent-map-interaction")||0)+1)}var b=[];a.states={STARTUP:"STARTUP",RENDERED:"RENDERED",OUT_FOR_DELIVERY:"OUT_FOR_DELIVERY",PICKED_UP:"PICKED_UP",YOU_ARE_NEXT:"YOU_ARE_NEXT",DELIVERED:"DELIVERED",ERROR:"ERROR",FATAL:"FATAL",ADDRESS_NOT_FOUND:"ADDRESS_NOT_FOUND",SKIPPED_STOP:"SKIPPED_STOP",DELIVERY_FAILED:"DELIVERY_FAILED",DELIVERY_ATTEMPTED:"DELIVERY_ATTEMPTED",PARTIALLY_DELIVERED:"PARTIALLY_DELIVERED",REJECTED:"REJECTED",NOT_DELIVERED:"NOT_DELIVERED"};
a.prototype.init=function(k){if(1!==k.nodeType)throw Error("containerElement must be a dom element");this.mapElement=k;this.platform=new H.service.Platform(c.platform.here);k=this.platform.createDefaultLayers();k.normal.map.setMax(c.maxZoom);this.map=new H.Map(this.mapElement,k.normal.map);new H.mapevents.Behavior(new H.mapevents.MapEvents(this.map));this.ui=H.ui.UI.createDefault(this.map,k);this.ui.removeControl("mapsettings");this.ui.removeControl("scalebar");this.map.addEventListener("dragend",
this.wasInteractedWith);this.map.addEventListener("dbltap",this.wasInteractedWith);this.map.addEventListener("tap",d);this.env.imperial&&this.ui.setUnitSystem(H.ui.UnitSystem.IMPERIAL);this.updateState(a.states.RENDERED);b.push(this)};a.prototype.addItem=function(a,b){b.init(this);this.mapItems[a]=b};a.prototype.destroy=function(){this.mapElement.innerHTML="";this.destroyed=!0;var a=b.indexOf(this);-1<a&&b.splice(a,1)};a.prototype.setPadding=function(a,b,d,f){try{this.map.getViewPort().setPadding(a,
b,d,f)}catch(c){}};a.prototype.setMapBounds=function(){var a=this.mapElement.offsetHeight,b=new H.map.Group;this.map.addObject(b);var d=this.mapItems,f=0,c=0,c=0;Object.keys(d).forEach(function(a){d[a].marker&&b.addObject(d[a].marker);d[a].bubbleContent&&d[a].bubbleContent.getBoundingClientRect&&(a=d[a].bubbleContent.getBoundingClientRect(),a.height>f&&(f=a.height))});var e=b.getBounds(),h=.3+.5*(500-Math.min(Math.max(a,200),500))/300,g=e.getRight()-e.getLeft(),m=e.getBottom()-e.getTop();0!==m&&0!==
a&&(c=a/Math.abs(m),c=f/c*5,5<c&&(c=5));a=h*m-c;m=.1*m-c;c=.1*g;g*=.1;e=new H.geo.Rect(e.getTop()-a,e.getLeft()-c,e.getBottom()+m,e.getRight()+g);this.map.setViewBounds(e);this.initialZoomTriggered=!0};a.prototype.updateState=function(a){this.state=a};a.prototype.wasInteractedWith=function(){this.interactedWith=!0;d()};a.prototype.handleResize=function(){this.destroyed||this.state===a.states.STARTUP||this.map.getViewPort().resize()};h.addEventListener("resize",e.debounce(function(){b.forEach(function(a){a.handleResize()})},
100));return a});g.when("A","rex-maptracker","rex-maptracker-item","rex-maptracker-environments","ready").register("rex-maptracker-deanssource",function(c,f,e,a){function d(a,b,d,c){l.mapItems.agent?l.mapItems.agent.updateLocation(d,c):l.addItem("agent",new e("agent",d,c));l.mapItems.destination&&l.mapItems.destination.updateLocation(a,b)}function b(){if(l.mapItems.agent&&l.mapItems.agent.marker){var a=l.mapItems.agent.marker.getParentGroup();a&&(a.removeObject(l.mapItems.agent.marker),l.ui.removeBubble(l.mapItems.agent.bubble.instant))}}
function k(a,b,d,c){"function"===typeof p.onChange&&(a={status:a,stops:b,refreshRate:30,url:h(n,v),mapObject:l},m&&(a.destinationTrustLevel=m),t&&(a.transporterTrustLevel=t),d&&(a.message="Map tracking failed for the trackingId: "+n+" with reason: "+d),c&&(a.lastStopsRemainingDecreaseTime=c),p.onChange(a))}function h(b,d){var c=a.getEnvConfig();return("localhost"===a.getTopLevelDomain()?"http://localhost:3000/mapdata":c.isPreProd?"https://securephotostorageservice-"+c.region+"-external.amazon.com":
"https://securephotostorageservice-"+c.region+"-external.amazon."+c.domain)+"/DEANSExternalPackageLocationDetailsProxy/trackingObjectId/"+b+"/clientName/"+d}var g="",r="",n,v="",p,q=null,m=0,z=null,t=0,A=0,y=0,l,B=function(a,e){function l(a){y++;3>=y?(k(f.states.ERROR,0,a),w(firstTimeInvoke?50:1E4)):k(f.states.FATAL,0,a)}function w(a){setTimeout(function(){B(n,v)},a)}c.$.ajax({url:h(a,e),headers:{"x-amzn-SessionId":g},dataType:"json",xhrFields:{withCredentials:!0},success:function(a){try{null!=a&&
a!=={}||l("EMPTY_RESPONSE");var c=null;a.destinationAddress&&a.destinationAddress.geoLocation?(q=c=a.destinationAddress,m=0):(c=q,m--);var e=null;a.transporterDetails&&a.transporterDetails.geoLocation?(z=e=a.transporterDetails,t=0):(e=z,t--);if(c&&-10<m&&e&&-6<t){var g=c.geoLocation.latitude,h=c.geoLocation.longitude,n=e.geoLocation.latitude,x=e.geoLocation.longitude,u=a.trackingObjectState,p=a.lastStopsRemainingDecreaseTime;y=0;switch(u){case f.states.PICKED_UP:case f.states.YOU_ARE_NEXT:d(g,h,n,
x);k(u,a.stopsRemaining,"",p);w(3E4);firstTimeInvoke=!1;break;case f.states.DELIVERED:d(g,h,g,h);b();k(u,0,"");break;case f.states.SKIPPED_STOP:d(g,h,n,x);k(u,a.stopsRemaining,"",p);w(3E4);firstTimeInvoke=!1;break;case f.states.PARTIALLY_DELIVERED:case f.states.DELIVERY_ATTEMPTED:case f.states.NOT_DELIVERED:case f.states.REJECTED:d(g,h,n,x);b();k(u,0,"");break;default:l("UNKNOWN_STATUS")}}else firstTimeInvoke&&3>A&&-10<m&&-6<t?(A++,w(50)):k(f.states.ADDRESS_NOT_FOUND,0,"")}catch(r){l(r.stack)}},error:function(a,
b,c){console.log("Error is :: "+a.responseText+" "+b+" "+c);l(a.responseText)}})};return{startPolling:function(a,b){p=a;l=b;n=a.trackingId;v=a.appId||"";if(!n)throw k(f.states.FATAL,0,"MISSING_TRACKING_ID"),Error("missing trackingId");if(p.sessionId)g=p.sessionId;else{if(!document.cookie)throw k(f.states.FATAL,0,"MISSING_COOKIE"),Error("missing cookie");a="";r=document.cookie.replace(/ /g,"");for(b=0;b<r.split(";").length;b++){var c=r.split(";")[b].split("\x3d")[0],d=r.split(";")[b].split("\x3d")[1];
"session-id"===c&&(a=d)}g=a}if(!g)throw k(f.states.FATAL,0,"MISSING_SESSION_ID"),Error("missing session id");firstTimeInvoke=!0;B(n,v)}}})});